<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shift Calendar 2026</title>

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    .bar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    select, button { padding: 8px; }
    #calendar { max-width: 1100px; margin: 0 auto; }
    .legend { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .dot { width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:6px; }
    .note { max-width:1100px; margin: 10px auto 0 auto; color:#333; font-size: 13px; line-height: 1.35; }
    code { background:#f4f4f4; padding:2px 4px; border-radius:4px; }

    /* Center + bold event titles */
    .fc-event-title {
      text-align: center;
      width: 100%;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <div class="bar">
    <label>
      Group:
      <select id="group">
        <optgroup label="6 Platoons">
          <option value="A">Platoon A</option>
          <option value="B">Platoon B</option>
          <option value="C">Platoon C</option>
          <option value="D" selected>Platoon D</option>
          <option value="E">Platoon E</option>
          <option value="F">Platoon F</option>
        </optgroup>
        <optgroup label="Fixed Shifts">
          <option value="D1">D1 (always Day)</option>
          <option value="D2">D2 (always Day)</option>
          <option value="A1">A1 (always Afternoon)</option>
          <option value="A2">A2 (always Afternoon)</option>
        </optgroup>
      </select>
    </label>

    <button id="export">Export ICS (iPhone) — 2026</button>

    <div class="legend">
      <span><span class="dot" style="background:#1e88e5"></span>Day</span>
      <span><span class="dot" style="background:#8e24aa"></span>Night</span>
      <span><span class="dot" style="background:#fb8c00"></span>Afternoon</span>
      <span><span class="dot" style="background:#2e7d32"></span>OFF</span>
    </div>
  </div>

  <div id="calendar"></div>

  <div class="note">
    Fixed year range: <code>2026-01-01 → 2026-12-31</code>
    <br/>• 14-day pattern: <code>2W 2O 3W 2O 2W 3O</code> (7 work + 7 off)
    <br/>• Platoons rotate blocks every 14 days: <code>Day → Night → Afternoon</code> (repeat)
    <br/>• Fixed shifts keep the same turn forever (but still follow the same 14-day work/off pattern).
  </div>

  <script>
    // -------------------------
    // Fixed year range (always 2026)
    // -------------------------
    const YEAR_FROM = "2026-01-01";
    const YEAR_TO   = "2026-12-31";

    // -------------------------
    // Colors (OFF is green)
    // -------------------------
    const COLORS = {
      Day: "#1e88e5",
      Afternoon: "#fb8c00",
      Night: "#8e24aa",
      Off: "#2e7d32"
    };

    // -------------------------
    // 14-day work/off pattern
    // Work 2, Off 2, Work 3, Off 2, Work 2, Off 3
    // -------------------------
    const PATTERN_14 = [
      "W","W","O","O",
      "W","W","W",
      "O","O",
      "W","W",
      "O","O","O"
    ];

    // Rotation order for platoons
    const TURN_ORDER = ["Day", "Night", "Afternoon"];

    // -------------------------
    // Anchors you provided
    // anchorDate = first day of a 14-day block
    // -------------------------
    const GROUPS = {
      // Platoons
      A: { mode: "rotate", anchorDate: "2026-01-12", anchorTurn: "Day" },
      B: { mode: "rotate", anchorDate: "2026-01-12", anchorTurn: "Afternoon" },
      C: { mode: "rotate", anchorDate: "2026-01-05", anchorTurn: "Day" },
      D: { mode: "rotate", anchorDate: "2026-01-12", anchorTurn: "Night" },
      E: { mode: "rotate", anchorDate: "2026-01-05", anchorTurn: "Afternoon" },
      F: { mode: "rotate", anchorDate: "2026-01-05", anchorTurn: "Night" },

      // Fixed shifts (always same turn; still follow PATTERN_14 for work/off)
      D1: { mode: "fixed", anchorDate: "2026-01-12", fixedTurn: "Day" },
      D2: { mode: "fixed", anchorDate: "2026-01-05", fixedTurn: "Day" },
      A1: { mode: "fixed", anchorDate: "2026-01-12", fixedTurn: "Afternoon" },
      A2: { mode: "fixed", anchorDate: "2026-01-05", fixedTurn: "Afternoon" }
    };

    // -------------------------
    // Helpers
    // -------------------------
    function iso(d) { return d.toISOString().slice(0, 10); }

    function addDays(date, days) {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }

    function dayDiff(a, b) {
      // whole-day diff between a and b, ignoring timezone
      const ms = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate()) - Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
      return Math.floor(ms / (1000 * 60 * 60 * 24));
    }

    function mod(n, m) { return ((n % m) + m) % m; }

    function turnIndex(turn) {
      const i = TURN_ORDER.indexOf(turn);
      if (i < 0) throw new Error("Invalid turn: " + turn);
      return i;
    }

    function turnToLabelUpper(turn) {
      if (turn === "Day") return "DAY SHIFT";
      if (turn === "Night") return "NIGHT SHIFT";
      return "AFTERNOON SHIFT";
    }

    // -------------------------
    // Core: compute shift for a group and date
    // -------------------------
    function getShiftForDate(groupKey, dateObj) {
      const cfg = GROUPS[groupKey];
      if (!cfg) throw new Error("Unknown group: " + groupKey);

      const anchor = new Date(cfg.anchorDate + "T00:00:00");
      const deltaDays = dayDiff(dateObj, anchor);

      const dayIn14 = mod(deltaDays, 14); // 0..13
      const wo = PATTERN_14[dayIn14];     // W or O

      if (wo === "O") return { label: "OFF", type: "Off" };

      let turn;
      if (cfg.mode === "fixed") {
        turn = cfg.fixedTurn;
      } else {
        const blocksFromAnchor = Math.floor((deltaDays - dayIn14) / 14); // can be negative
        const t0 = turnIndex(cfg.anchorTurn);
        turn = TURN_ORDER[mod(t0 + blocksFromAnchor, 3)];
      }

      return { label: turnToLabelUpper(turn), type: turn };
    }

    // -------------------------
    // Event generation for the fixed year
    // -------------------------
    function generateYearEvents(groupKey) {
      const start = new Date(YEAR_FROM + "T00:00:00");
      const end = new Date(YEAR_TO + "T00:00:00");

      const events = [];
      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const s = getShiftForDate(groupKey, d);
        const color = COLORS[s.type] || COLORS.Off;

        events.push({
          title: s.label,              // already uppercase
          start: iso(new Date(d)),
          allDay: true,
          backgroundColor: color,
          borderColor: color
        });
      }
      return events;
    }

    // -------------------------
    // ICS export for full year 2026 (includes OFF)
    // -------------------------
    function toICSDate(isoYYYYMMDD) { return isoYYYYMMDD.replaceAll("-", ""); }

    function downloadText(filename, text) {
      const blob = new Blob([text], { type: "text/calendar;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(link.href);
    }

    function buildICSYear(groupKey) {
      const from = new Date(YEAR_FROM + "T00:00:00");
      const to = new Date(YEAR_TO + "T00:00:00");

      const lines = [];
      lines.push("BEGIN:VCALENDAR");
      lines.push("VERSION:2.0");
      lines.push("PRODID:-//ShiftCalendar//2026//EN");
      lines.push("CALSCALE:GREGORIAN");
      lines.push("METHOD:PUBLISH");

      const dtstamp = new Date().toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";

      for (let d = new Date(from); d <= to; d.setDate(d.getDate() + 1)) {
        const s = getShiftForDate(groupKey, d);
        const startISO = iso(new Date(d));
        const endISO = iso(addDays(d, 1)); // exclusive

        lines.push("BEGIN:VEVENT");
        lines.push(`UID:${groupKey}-${startISO}@shiftcalendar.local`);
        lines.push(`DTSTAMP:${dtstamp}`);
        lines.push(`SUMMARY:${s.label}`);
        lines.push(`DTSTART;VALUE=DATE:${toICSDate(startISO)}`);
        lines.push(`DTEND;VALUE=DATE:${toICSDate(endISO)}`);
        lines.push("END:VEVENT");
      }

      lines.push("END:VCALENDAR");
      return lines.join("\r\n");
    }

    // -------------------------
    // Calendar UI (MONTH ONLY)
    // -------------------------
    let calendar;

    function renderForSelectedGroup() {
      const groupKey = document.getElementById("group").value;
      const events = generateYearEvents(groupKey);

      if (!calendar) {
        calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
          initialView: "dayGridMonth", // month only
          height: "auto",
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "" // remove week toggle
          },
          initialDate: YEAR_FROM,
          events
        });
        calendar.render();
      } else {
        calendar.removeAllEvents();
        events.forEach(e => calendar.addEvent(e));
        calendar.changeView("dayGridMonth");
      }
    }

    document.getElementById("group").addEventListener("change", renderForSelectedGroup);

    document.getElementById("export").addEventListener("click", () => {
      const groupKey = document.getElementById("group").value;
      const ics = buildICSYear(groupKey);
      downloadText(`Shift-${groupKey}-2026.ics`, ics);
    });

    // First render
    renderForSelectedGroup();
  </script>
</body>
</html>

