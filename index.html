<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shift Calendar 2026</title>

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <style>
    :root{
      --bg: #0f1115;
      --panel: #141824;
      --text: #e7e9ee;
      --muted: #a7afc0;
      --border: #263048;

      --day: #1e88e5;
      --night: #8e24aa;
      --aft: #fb8c00;
      --off: #2e7d32;
    }

    body { font-family: Arial, sans-serif; margin: 16px; background: var(--bg); color: var(--text); }
    .bar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    select, button { padding: 8px; background: var(--panel); color: var(--text); border: 1px solid var(--border); border-radius: 10px; }
    select:focus, button:focus { outline: 2px solid rgba(255,255,255,0.12); outline-offset: 2px; }

    #calendar { max-width: 1100px; margin: 0 auto; background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 10px; }

    .legend { display:flex; gap:12px; align-items:center; flex-wrap:wrap; color: var(--muted); }
    .dot { width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:6px; }
    .note { max-width:1100px; margin: 10px auto 0 auto; color: var(--muted); font-size: 13px; line-height: 1.35; }
    code { background: rgba(255,255,255,0.06); padding:2px 6px; border-radius:6px; color: var(--text); }

    /* Center + bold event titles */
    .fc-event-title {
      text-align: center;
      width: 100%;
      font-weight: 800;
      letter-spacing: 0.4px;
    }

    /* Dark mode tuning for FullCalendar */
    .fc { color: var(--text); }
    .fc .fc-toolbar-title { color: var(--text); }
    .fc .fc-button { background: rgba(255,255,255,0.06); border: 1px solid var(--border); color: var(--text); }
    .fc .fc-button:hover { background: rgba(255,255,255,0.10); }
    .fc .fc-button-primary:not(:disabled).fc-button-active,
    .fc .fc-button-primary:not(:disabled):active {
      background: rgba(255,255,255,0.14);
      border-color: rgba(255,255,255,0.14);
    }

    .fc-theme-standard td, .fc-theme-standard th, .fc-theme-standard .fc-scrollgrid {
      border-color: rgba(255,255,255,0.10);
    }
    .fc .fc-daygrid-day-number { color: var(--muted); }
    .fc .fc-col-header-cell-cushion { color: var(--muted); }

    /* Make OFF background events cover the cell nicely */
    .fc-bg-event { opacity: 0.55; }

    /* Mobile compact view: smaller font */
    @media (max-width: 600px) {
      body { margin: 10px; }
      #calendar { padding: 6px; }
      .fc-event-title { font-size: 10px; }
      .fc .fc-toolbar-title { font-size: 18px; }
      select, button { padding: 8px; }
    }
  </style>
</head>
<body>

  <div class="bar">
    <label>
      Group:
      <select id="group">
        <optgroup label="6 Platoons">
          <option value="A">Platoon A</option>
          <option value="B">Platoon B</option>
          <option value="C">Platoon C</option>
          <option value="D">Platoon D</option>
          <option value="E">Platoon E</option>
          <option value="F">Platoon F</option>
        </optgroup>
        <optgroup label="Fixed Shifts">
          <option value="D1">D1 (always Day)</option>
          <option value="D2">D2 (always Day)</option>
          <option value="A1">A1 (always Afternoon)</option>
          <option value="A2">A2 (always Afternoon)</option>
        </optgroup>
      </select>
    </label>

    <button id="export">Export ICS (iPhone) — 2026</button>

    <div class="legend">
      <span><span class="dot" style="background:var(--day)"></span>Day</span>
      <span><span class="dot" style="background:var(--night)"></span>Night</span>
      <span><span class="dot" style="background:var(--aft)"></span>Afternoon</span>
      <span><span class="dot" style="background:var(--off)"></span>OFF</span>
    </div>
  </div>

  <div id="calendar"></div>

  <div class="note">
    Fixed year range: <code>2026-01-01 → 2026-12-31</code>
    <br/>• 14-day pattern: <code>2W 2O 3W 2O 2W 3O</code> (7 work + 7 off)
    <br/>• Platoons rotate blocks every 14 days: <code>Day → Night → Afternoon</code> (repeat)
  </div>

  <script>
    // -------------------------
    // Fixed year range (always 2026)
    // -------------------------
    const YEAR_FROM = "2026-01-01";
    const YEAR_TO   = "2026-12-31";

    // Timezone string for iPhone calendar naming (no VTIMEZONE block; iOS handles this well)
    const ICS_TZ = "America/Toronto"; // Montreal uses the same rules (ET)

    // -------------------------
    // Colors
    // -------------------------
    const COLORS = {
      Day: getComputedStyle(document.documentElement).getPropertyValue("--day").trim() || "#1e88e5",
      Afternoon: getComputedStyle(document.documentElement).getPropertyValue("--aft").trim() || "#fb8c00",
      Night: getComputedStyle(document.documentElement).getPropertyValue("--night").trim() || "#8e24aa",
      Off: getComputedStyle(document.documentElement).getPropertyValue("--off").trim() || "#2e7d32"
    };

    // -------------------------
    // 14-day work/off pattern
    // Work 2, Off 2, Work 3, Off 2, Work 2, Off 3
    // -------------------------
    const PATTERN_14 = [
      "W","W","O","O",
      "W","W","W",
      "O","O",
      "W","W",
      "O","O","O"
    ];

    // Rotation order for platoons (as you specified)
    const TURN_ORDER = ["Day", "Night", "Afternoon"];

    // -------------------------
    // Anchors you provided
    // anchorDate = first day of a 14-day block
    // -------------------------
    const GROUPS = {
      // Platoons
      A: { mode: "rotate", anchorDate: "2026-01-12", anchorTurn: "Day" },
      B: { mode: "rotate", anchorDate: "2026-01-12", anchorTurn: "Afternoon" },
      C: { mode: "rotate", anchorDate: "2026-01-05", anchorTurn: "Day" },
      D: { mode: "rotate", anchorDate: "2026-01-12", anchorTurn: "Night" },
      E: { mode: "rotate", anchorDate: "2026-01-05", anchorTurn: "Afternoon" },
      F: { mode: "rotate", anchorDate: "2026-01-05", anchorTurn: "Night" },

      // Fixed shifts (always same turn; still follow PATTERN_14 for work/off)
      D1: { mode: "fixed", anchorDate: "2026-01-12", fixedTurn: "Day" },
      D2: { mode: "fixed", anchorDate: "2026-01-05", fixedTurn: "Day" },
      A1: { mode: "fixed", anchorDate: "2026-01-12", fixedTurn: "Afternoon" },
      A2: { mode: "fixed", anchorDate: "2026-01-05", fixedTurn: "Afternoon" }
    };

    // -------------------------
    // Shift hours for ICS export
    // Day:       06:45 -> 17:30
    // Afternoon: 16:45 -> 03:30 (next day)
    // Night:     20:45 -> 07:30 (next day)
    // -------------------------
    const SHIFT_TIMES = {
      Day:       { start: "064500", end: "173000", crossesMidnight: false },
      Afternoon: { start: "164500", end: "033000", crossesMidnight: true  },
      Night:     { start: "204500", end: "073000", crossesMidnight: true  }
    };

    // -------------------------
    // Helpers
    // -------------------------
    function iso(d) { return d.toISOString().slice(0, 10); }

    function addDays(date, days) {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }

    function dayDiff(a, b) {
      // whole-day diff between a and b, ignoring timezone
      const ms = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate()) - Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
      return Math.floor(ms / (1000 * 60 * 60 * 24));
    }

    function mod(n, m) { return ((n % m) + m) % m; }

    function turnIndex(turn) {
      const i = TURN_ORDER.indexOf(turn);
      if (i < 0) throw new Error("Invalid turn: " + turn);
      return i;
    }

    function turnToLabelUpper(turn, compact) {
      if (compact) {
        if (turn === "Day") return "DAY";
        if (turn === "Night") return "NIGHT";
        return "AFT";
      }
      if (turn === "Day") return "DAY SHIFT";
      if (turn === "Night") return "NIGHT SHIFT";
      return "AFTERNOON SHIFT";
    }

    function isMobileCompact() {
      return window.matchMedia && window.matchMedia("(max-width: 600px)").matches;
    }

    // -------------------------
    // Core: compute shift for a group and date
    // Returns:
    //  - type: "Day" | "Night" | "Afternoon" | "Off"
    //  - label: string
    // -------------------------
    function getShiftForDate(groupKey, dateObj) {
      const cfg = GROUPS[groupKey];
      if (!cfg) throw new Error("Unknown group: " + groupKey);

      const anchor = new Date(cfg.anchorDate + "T00:00:00");
      const deltaDays = dayDiff(dateObj, anchor);

      const dayIn14 = mod(deltaDays, 14); // 0..13
      const wo = PATTERN_14[dayIn14];     // W or O

      if (wo === "O") return { label: "OFF", type: "Off" };

      let turn;
      if (cfg.mode === "fixed") {
        turn = cfg.fixedTurn;
      } else {
        const blocksFromAnchor = Math.floor((deltaDays - dayIn14) / 14); // can be negative
        const t0 = turnIndex(cfg.anchorTurn);
        turn = TURN_ORDER[mod(t0 + blocksFromAnchor, 3)];
      }

      return { label: turn, type: turn };
    }

    // -------------------------
    // Event generation for the fixed year (Month view)
    // - Shift days: allDay event with title (compact on mobile)
    // - OFF days: background event only (green), no title
    // -------------------------
    function generateYearEvents(groupKey) {
      const start = new Date(YEAR_FROM + "T00:00:00");
      const end = new Date(YEAR_TO + "T00:00:00");
      const compact = isMobileCompact();

      const events = [];
      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const s = getShiftForDate(groupKey, d);

        if (s.type === "Off") {
          // background-only green block, no text
          events.push({
            start: iso(new Date(d)),
            allDay: true,
            display: "background",
            backgroundColor: COLORS.Off
          });
          continue;
        }

        const color = COLORS[s.type];

        events.push({
          title: turnToLabelUpper(s.type, compact), // DAY/NIGHT/AFT on mobile, full text on desktop
          start: iso(new Date(d)),
          allDay: true,
          backgroundColor: color,
          borderColor: color
        });
      }
      return events;
    }

    // -------------------------
    // ICS export for full year 2026
    // - Creates TIMED events for working shifts with your exact hours
    // - OFF days: no event (since you want OFF to be just green in the UI)
    // - Adds calendar name (X-WR-CALNAME) so iPhone shows it properly
    // -------------------------
    function ymdToICSDate(isoYYYYMMDD) { return isoYYYYMMDD.replaceAll("-", ""); }

    function downloadText(filename, text) {
      const blob = new Blob([text], { type: "text/calendar;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(link.href);
    }

    function buildICSYear(groupKey) {
      const from = new Date(YEAR_FROM + "T00:00:00");
      const to = new Date(YEAR_TO + "T00:00:00");

      const calName = `Shift Schedule 2026 - ${groupKey}`;
      const lines = [];
      lines.push("BEGIN:VCALENDAR");
      lines.push("VERSION:2.0");
      lines.push("PRODID:-//ShiftCalendar//2026//EN");
      lines.push("CALSCALE:GREGORIAN");
      lines.push("METHOD:PUBLISH");
      lines.push(`X-WR-CALNAME:${calName}`);
      lines.push(`X-WR-TIMEZONE:${ICS_TZ}`);

      const dtstamp = new Date().toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";

      for (let d = new Date(from); d <= to; d.setDate(d.getDate() + 1)) {
        const s = getShiftForDate(groupKey, d);
        if (s.type === "Off") continue; // no OFF events in ICS

        const t = SHIFT_TIMES[s.type];
        const startISO = iso(new Date(d));
        const startDateICS = ymdToICSDate(startISO);

        let endDateObj = new Date(d);
        if (t.crossesMidnight) endDateObj = addDays(endDateObj, 1);

        const endISO = iso(endDateObj);
        const endDateICS = ymdToICSDate(endISO);

        const dtStart = `${startDateICS}T${t.start}`;
        const dtEnd = `${endDateICS}T${t.end}`;

        const summary = (s.type === "Day") ? "DAY SHIFT" :
                        (s.type === "Night") ? "NIGHT SHIFT" : "AFTERNOON SHIFT";

        lines.push("BEGIN:VEVENT");
        lines.push(`UID:${groupKey}-${startISO}-${s.type}@shiftcalendar.local`);
        lines.push(`DTSTAMP:${dtstamp}`);
        lines.push(`SUMMARY:${summary}`);
        lines.push(`DTSTART;TZID=${ICS_TZ}:${dtStart}`);
        lines.push(`DTEND;TZID=${ICS_TZ}:${dtEnd}`);
        lines.push("END:VEVENT");
      }

      lines.push("END:VCALENDAR");
      return lines.join("\r\n");
    }

    // -------------------------
    // Remember selected group
    // -------------------------
    const GROUP_STORE_KEY = "SHIFT_SELECTED_GROUP";
    function loadSelectedGroup() {
      const v = localStorage.getItem(GROUP_STORE_KEY);
      return (v && GROUPS[v]) ? v : "D";
    }
    function saveSelectedGroup(v) {
      localStorage.setItem(GROUP_STORE_KEY, v);
    }

    // -------------------------
    // Calendar UI (MONTH ONLY)
    // -------------------------
    let calendar;

    function renderForSelectedGroup() {
      const groupKey = document.getElementById("group").value;
      saveSelectedGroup(groupKey);

      const events = generateYearEvents(groupKey);

      if (!calendar) {
        calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
          initialView: "dayGridMonth", // month only
          height: "auto",
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "" // no week toggle
          },
          initialDate: YEAR_FROM,
          events
        });
        calendar.render();
      } else {
        calendar.removeAllEvents();
        events.forEach(e => calendar.addEvent(e));
        calendar.changeView("dayGridMonth");
      }
    }

    // init selected group
    document.getElementById("group").value = loadSelectedGroup();

    document.getElementById("group").addEventListener("change", () => {
      renderForSelectedGroup();
    });

    document.getElementById("export").addEventListener("click", () => {
      const groupKey = document.getElementById("group").value;
      const ics = buildICSYear(groupKey);
      downloadText(`Shift-${groupKey}-2026.ics`, ics);
    });

    // Re-render if screen size changes (mobile/desktop titles)
    if (window.matchMedia) {
      const mq = window.matchMedia("(max-width: 600px)");
      mq.addEventListener?.("change", () => renderForSelectedGroup());
    }

    // First render
    renderForSelectedGroup();
  </script>
</body>
</html>
